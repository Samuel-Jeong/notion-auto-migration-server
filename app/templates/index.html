<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Notion Local Backup</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    .wrap { display: grid; grid-template-columns: 1fr 360px; min-height: 100vh; }
    .main { padding: 32px; }
    .side { border-left: 1px solid #eee; padding: 16px; background: #fafafa; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 20px; background: #fff; }
    h1 { margin: 0 0 16px 0; }
    input, button, select { padding: 8px; border-radius: 8px; border: 1px solid #bbb; }
    form { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    .progress { width: 100%; height: 8px; background: #eee; border-radius: 999px; overflow: hidden; margin-top: 6px; }
    .bar { height: 100%; background: #4f46e5; width: 0%; transition: width .2s; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .muted { color:#666; font-size:12px; }
    .status { font-size: 12px; padding: 2px 8px; border-radius: 6px; background:#eef; }
    .btn { cursor:pointer; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .pill { font-size:12px; padding:2px 6px; border-radius:999px; background:#eee; }
    .pill.ok { background:#e6f6e6; }
    .pill.wait { background:#f6f0e6; }
    .actions { display:flex; gap:6px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="main">
    <h1>Notion Local Backup</h1>

    <div class="card">
      <h2>덤프</h2>
      <form id="dumpForm">
        <input type="text" name="page_id" placeholder="노션 루트 페이지 ID 또는 URL" style="flex:1" required />
        <button type="submit" class="btn">시작</button>
      </form>
    </div>

    <div class="card">
      <h2>마이그레이션</h2>
      <form id="migForm">
        <select name="dump_name" required id="dumpSelect">
          <option value="" disabled selected>덤프 선택</option>
          {% for d in dumps %}
            <option value="{{ d.name }}">{{ d.name }}</option>
          {% endfor %}
        </select>
        <input type="text" name="target_page_id" placeholder="타겟 노션 페이지 ID 또는 URL" style="flex:1" required />
        <button type="submit" class="btn">시작</button>
      </form>
    </div>

    <div class="card">
      <div class="row">
        <h2 style="margin:0">덤프 목록</h2>
        <div>
          <button id="refreshDumpsBtn" class="btn">새로고침</button>
        </div>
      </div>
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th>덤프 이름</th>
            <th>상태</th>
            <th>링크</th>
          </tr>
        </thead>
        <tbody id="dumpTbody">
          {% for d in dumps %}
            <tr>
              <td>{{ d.name }}</td>
              <td><span class="pill ok">완료</span></td>
              <td><a href="/api/browse/{{ d.name }}/" target="_blank">/api/browse/{{ d.name }}/</a></td>
            </tr>
          {% endfor %}
          {% if not dumps %}
            <tr>
              <td colspan="3" style="text-align: center; color: #666; padding: 32px;">
                덤프가 없습니다. 위에서 새 덤프를 생성해보세요.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="side">
    <h3>작업 진행 상황</h3>
    <div class="card">
      <h4>덤프</h4>
      <div id="dumpJobList"></div>
    </div>
    <div class="card">
      <h4>마이그레이션</h4>
      <div id="migList"></div>
    </div>
  </div>
</div>

<script>
async function postJSON(url, body) {
  const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

document.getElementById('dumpForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const page_id = fd.get('page_id');
  await postJSON('/jobs/dump', {page_id});
  e.target.reset();
});

document.getElementById('migForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const dump_name = fd.get('dump_name');
  const target_page_id = fd.get('target_page_id');
  await postJSON('/jobs/migrate', {dump_name, target_page_id});
  e.target.reset();
});

/* ────────────────────────────────
   덤프 목록 렌더링
   ──────────────────────────────── */
const tbody = document.getElementById('dumpTbody');
const dumpSelect = document.getElementById('dumpSelect');
const refreshBtn = document.getElementById('refreshDumpsBtn');

function rowHTML(it){
  const status = it.ready ? '<span class="pill ok">완료</span>' : '<span class="pill wait">진행 중</span>';
  return `
    <tr>
      <td>${it.name}</td>
      <td>${status}</td>
      <td><a href="${it.static_url}" target="_blank">${it.static_url}</a></td>
    </tr>
  `;
}

function renderDumps(items){
  tbody.innerHTML = items.map(rowHTML).join('');
  const current = dumpSelect.value;
  dumpSelect.innerHTML = `<option value="" disabled ${current ? "" : "selected"}>덤프 선택</option>` +
    items.map(it => `<option value="${it.name}">${it.name}</option>`).join('');
  if (items.some(x => x.name === current)) dumpSelect.value = current;
}

async function fetchDumpsOnce(){
  const r = await fetch('/api/dumps?detail=1');
  if (!r.ok) throw new Error(await r.text());
  const data = await r.json();
  renderDumps(data.entries || []);
}

async function refreshDumps(){
  refreshBtn.disabled = true;
  refreshBtn.textContent = '갱신 중...';
  try { await fetchDumpsOnce(); }
  catch(e){ console.error(e); alert('덤프 목록을 불러오지 못했습니다.'); }
  finally { refreshBtn.disabled = false; refreshBtn.textContent = '새로고침'; }
}
refreshBtn.addEventListener('click', refreshDumps);

/* ────────────────────────────────
   작업 진행 상황(SSE) + 취소/제거
   ──────────────────────────────── */
const dumpJobList = document.getElementById('dumpJobList');
const migList = document.getElementById('migList');
const byId = new Map();

async function cancelJob(id){
  await postJSON(`/jobs/${id}/cancel`, {});
}
async function removeJob(id){
  await postJSON(`/jobs/${id}/remove`, {});
}

function renderJob(j){
  const id = j.id;
  let el = byId.get(id);
  if(!el){
    el = document.createElement('div');
    el.style.marginBottom = '12px';
    el.innerHTML = `
      <div class="row">
        <div>
          <b>${j.type.toUpperCase()}</b>
          <span class="status">${j.status}</span>
          <span class="muted">${id.slice(0,8)}</span>
        </div>
        <div class="actions" data-actions></div>
      </div>
      <div class="muted" data-msg></div>
      <div class="progress"><div class="bar" data-bar></div></div>
    `;
    byId.set(id, el);
    (j.type==='dump'?dumpJobList:migList).prepend(el);
  }
  el.querySelector('.status').textContent = j.status;
  el.querySelector('[data-msg]').textContent = j.message || '';
  el.querySelector('[data-bar]').style.width = (j.progress||0)+'%';

  // 액션 버튼
  const act = el.querySelector('[data-actions]');
  act.innerHTML = '';
  if (j.status === 'queued' || j.status === 'running') {
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = '취소';
    btn.onclick = ()=> cancelJob(j.id).catch(console.error);
    act.appendChild(btn);
  } else {
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = '제거';
    btn.onclick = ()=> removeJob(j.id).catch(console.error);
    act.appendChild(btn);
  }

  // 덤프 완료 시 목록 즉시 갱신
  if (j.type === 'dump' && (j.status === 'done' || j.status === 'canceled')) {
    fetchDumpsOnce().catch(console.error);
  }
}

function applySnapshot(items){
  dumpJobList.innerHTML = ''; migList.innerHTML = ''; byId.clear();
  items.forEach(renderJob);
}

(function connectJobsSSE(){
  const es = new EventSource('/jobs/stream');
  es.onmessage = (ev)=>{
    const data = JSON.parse(ev.data);
    if(data.kind==='snapshot') applySnapshot(data.items);
    if(data.kind==='job_added' || data.kind==='job_update') renderJob(data.job);
  };
  es.onerror = ()=>{ es.close(); setTimeout(connectJobsSSE, 1500); };
})();

/* 덤프 목록 자동 갱신(SSE) */
(function connectDumpsSSE(){
  const es = new EventSource('/api/dumps/stream?detail=1');
  es.onmessage = (ev) => {
    const data = JSON.parse(ev.data);
    renderDumps(data.entries || []);
  };
  es.addEventListener('ping', ()=>{});
  es.onerror = () => { es.close(); setTimeout(connectDumpsSSE, 1500); };
})();
</script>
</body>
</html>